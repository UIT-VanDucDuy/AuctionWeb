<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông báo thời gian thực</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .badge-type { font-size: 0.75rem; }
        .card-noti { border: none; border-left: 4px solid #6f42c1; }
        .time { font-size: .85rem; color: #6c757d; }
        .ws-status.connected { color: #198754; }
        .ws-status.disconnected { color: #dc3545; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
    <script>
        let socket;
        function connect() {
            const log = (msg) => {
                const el = document.getElementById('log');
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = msg;
                el.prepend(li);
            };

            try {
                socket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/notification');

                socket.onopen = () => {
                    document.getElementById('wsStatus').textContent = 'Đã kết nối';
                    document.getElementById('wsStatus').classList.remove('disconnected');
                    document.getElementById('wsStatus').classList.add('connected');
                    log('✅ Kết nối WebSocket thành công');
                };

                socket.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        renderMessage(msg);
                    } catch (e) {
                        log('Nhận dữ liệu (raw): ' + event.data);
                    }
                };

                socket.onclose = () => {
                    document.getElementById('wsStatus').textContent = 'Mất kết nối';
                    document.getElementById('wsStatus').classList.remove('connected');
                    document.getElementById('wsStatus').classList.add('disconnected');
                    log('❌ WebSocket đóng kết nối');
                };

                socket.onerror = (err) => {
                    log('Lỗi WebSocket: ' + (err?.message || 'unknown'));
                };
            } catch (e) {
                log('Không thể khởi tạo WebSocket: ' + e.message);
            }
        }

        function renderMessage(message) {
            const container = document.getElementById('messages');
            const card = document.createElement('div');
            card.className = 'card card-noti mb-3';
            const body = document.createElement('div');
            body.className = 'card-body';
            const header = document.createElement('div');
            header.className = 'd-flex justify-content-between align-items-center mb-2';
            const title = document.createElement('h6');
            title.className = 'mb-0';
            const badge = document.createElement('span');
            badge.className = 'badge rounded-pill text-bg-secondary badge-type';
            let contentText = '';
            let timeText = '';
            if (message?.type === 'NOTIFICATION') {
                badge.textContent = 'NOTIFICATION';
                const n = message.data || message.notification || {};
                contentText = n.notification || JSON.stringify(n);
                timeText = n.time ? new Date(n.time).toLocaleString() : new Date().toLocaleString();
            } else if (message?.type === 'SUCCESS') {
                badge.textContent = 'SUCCESS';
                contentText = message.data || 'Thành công';
                timeText = new Date().toLocaleString();
            } else if (message?.type === 'ERROR') {
                badge.textContent = 'ERROR';
                contentText = message.data || 'Lỗi';
                timeText = new Date().toLocaleString();
            } else {
                badge.textContent = 'MESSAGE';
                contentText = JSON.stringify(message);
                timeText = new Date().toLocaleString();
            }
            title.textContent = contentText;
            const time = document.createElement('div');
            time.className = 'time';
            time.textContent = timeText;
            header.appendChild(badge);
            header.appendChild(time);
            body.appendChild(header);
            const pre = document.createElement('pre');
            pre.className = 'mb-0 text-muted';
            pre.textContent = contentText;
            body.appendChild(pre);
            card.appendChild(body);
            container.prepend(card);
        }

        window.addEventListener('DOMContentLoaded', connect);
    </script>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Thông báo thời gian thực</h3>
        <span id="wsStatus" class="ws-status disconnected">Mất kết nối</span>
    </div>
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">Thông báo mới nhất</div>
                <div class="card-body" id="messages">
                    <p class="text-muted mb-0">Chưa có thông báo.</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Nhật ký kết nối</div>
                <ul class="list-group list-group-flush" id="log"></ul>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



